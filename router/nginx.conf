server {
  # Listen on production port so in development can
  # run container using `--net host` for internal redirects
  listen 9000;

  # Do not merge slashes in URL paths 
  # e.g http://hub.stenci.la/open/github://user/repo/
  merge_slashes off;

  location /internal/jobs/broker {
    # Internal proxy URL to job queue broker to be used with `X-Accel-Redirect`
    # to restrict access.

    # Currently turned off pending working use of a http compatible
    # messaging protocol e.g. STOMP
    #  internal;
    #  proxy_pass ${BROKER_URL};
  }

  location @job-connect {
    # Internal proxy URL to jobs to be used with `X-Accel-Redirect`
    # to restrict access.
    internal;

    # This approach, using a named location and setting an additional
    # header `X-Accel-Redirect-URL` is necessary to be able to use HTTP
    # to connect because it will preserve HTTP methods other than GET i.e POST.
    # That may not necessary for WebSockets (?) but nonetheless it is useful to
    # be able to use HTTP to make requests to the job session (especially
    # for debugging).
    # See https://serverfault.com/a/838447
    set $url $upstream_http_x_accel_redirect_url;
    proxy_pass $url;
    # Pass on the upgrade header for Websocket support
    proxy_set_header Upgrade $http_upgrade;
  }

  location / {
    # Proxy everything else to director
    proxy_set_header Host $http_host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $remote_addr;
    proxy_set_header X-Scheme $scheme;
    proxy_pass ${DIRECTOR_URL};
  }
}

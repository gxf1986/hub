{% extends 'open/main.html' %}
{% block main %}
    <iframe class="open-embed" id="article_display_{{ public_id }}" src="{{ raw_source }}"></iframe>
    {% include 'open/_output_footer.html' %}
{% endblock %}
{% block open_scripts %}
    <script>
      let conversionsFooter = document.querySelector('.conversions-footer')
      let pageFooter
      let pageFooterPosition = -1
      let conversionFooterOriginalBottom = -1

      {% if user_owns_conversion %}
        const feedbackModal = new Vue(
          {
            el: '#feedback_modal',
            delimiters: ['[[', ']]'],
            data: {
              rating: null,
              submitted: false,
              active: false,
              submitInProgress: false,
              comments: '',
              emailAddress: '',
              submitUrl: '{% url "open_feedback" public_id %}',
              submissionError: null,
              ratingErrors: null,
              emailErrors: null
            },
            methods: {
              showModal () {
                this.active = true
              },
              hideModal () {
                if (this.submitInProgress)
                  return

                this.active = false
              },
              setRating (rating) {
                this.ratingError = null
                this.rating = rating
              },
              send () {
                this.ratingErrors = null
                this.emailErrors = null

                if (this.rating === null) {
                  this.ratingErrors = ['Please select a rating.']
                  return
                }

                this.submissionError = null
                fetch(this.submitUrl, {
                  method: 'POST',
                  headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                    'X-CSRFToken': utils.cookie('csrftoken'),
                  },
                  credentials: 'same-origin',
                  body: new URLSearchParams({
                    rating: this.rating,
                    comments: this.comments,
                    email_address: this.emailAddress
                  })
                }).then(
                  response => {
                    this.submitInProgress = false
                    return response.json()
                  },
                  failureResponse => {
                    this.submitInProgress = false
                    this.submissionError = failureResponse
                  }).then(data => {
                  if (data.success) {
                    this.submitted = true
                  } else {
                    if (data.errors) {
                      this.emailErrors = data.errors.email_address || null
                      this.ratingErrors = data.errors.rating || null
                    } else {
                      this.submissionError = 'An unknown error occurred during send.'
                    }

                    this.submissionError = null
                    this.submitted = false
                  }
                })
              }
            }
          })

        document.getElementById('feedback_button').onclick = function () {
          feedbackModal.showModal()
        }
      {% endif %}

      {% if log_messages %}
        document.getElementById('warnings_button').onclick = function (e) {
          e.preventDefault()
          document.getElementById('warnings_modal').classList.add('is-active')
          return false
        }

        document.getElementById('warnings_modal_close').onclick = function (e) {
          e.preventDefault()
          document.getElementById('warnings_modal').classList.remove('is-active')
          return false
        }
      {% endif %}
      {% if conversion_success %}
        const parentTitleEl = document.querySelector('title')

        const articleDisplay = document.getElementById('article_display_{{ public_id }}')

        function updateParentTitle () {
          let subTitle = articleDisplay.contentDocument.querySelector('title')
          if (subTitle)
            parentTitleEl.textContent = 'Open : Stencila : ' + subTitle.textContent
          articleDisplay.style.height = `${articleDisplay.contentWindow.document.body.scrollHeight}px`
          updatePageFooterPosition()
          scrollChange()
        }

        articleDisplay.addEventListener('load', function () {
          articleDisplay.contentWindow.document.addEventListener('click', documentClick)
          updateParentTitle()
        })

      {% endif %}

      function updatePageFooterPosition () {
        if (!pageFooter || !conversionsFooter) return
        pageFooterPosition = pageFooter.getBoundingClientRect().top
        if (conversionFooterOriginalBottom === -1)
          conversionFooterOriginalBottom = parseInt(getComputedStyle(conversionsFooter).getPropertyValue('bottom'))
      }

      function scrollChange () {
        if (pageFooterPosition === -1) return

        const windowBottom = window.innerHeight + window.scrollY

        if (windowBottom > pageFooterPosition) {
          conversionsFooter.style.bottom = (windowBottom - pageFooterPosition) + conversionFooterOriginalBottom + 'px'
        } else {
          conversionsFooter.style.bottom = conversionFooterOriginalBottom + 'px'
        }
      }

      document.addEventListener('scroll', scrollChange)
      window.addEventListener('resize', function () {
        updatePageFooterPosition()
        scrollChange()
      })

      let downloadDropdown = null

      if (document.getElementById('download_dropdown')) {
        downloadDropdown = new Vue({
          el: '#download_dropdown',
          data: {
            active: false
          },
          methods: {
            toggle () {
              this.active ? this.hide() : this.show()
            },
            show () {
              this.active = true
            },
            hide () {
              this.active = false
            }
          }
        })
      }

      let shareDropdown = null

      if (document.getElementById('share_dropdown')) {
        shareDropdown = new Vue({
          el: '#share_dropdown',
          data: {
            active: false,
            postCopy: false
          },
          methods: {
            toggle () {
              this.active ? this.hide() : this.show()
            },
            show () {
              this.postCopy = false
              this.active = true
            },
            hide () {
              this.active = false
              this.postCopy = false
            },
            copy () {
              const shareUrlInput = this.$refs['share-url']
              shareUrlInput.focus()
              shareUrlInput.select()
              document.execCommand('copy')
              this.postCopy = true
            }
          }
        })
      }

      function documentClick (e) {
        let target = e.target
        let downloadButton = document.getElementById('download_dropdown_button')
        let shareDropdownEl = document.getElementById('share_dropdown')

        let isInDownloadButton = false
        let isInShareDropdown = false

        while (target) {
          if (target === downloadButton || target === shareDropdownEl) {
            if (target === downloadButton) isInDownloadButton = true
            else isInShareDropdown = true
            break
          }
          target = target.parentElement
        }

        if (downloadDropdown !== null && !isInDownloadButton)
          downloadDropdown.hide()

        if (shareDropdown !== null && !isInShareDropdown)
          shareDropdown.hide()
      }

      document.addEventListener('click', documentClick)

      window.addEventListener('load', function () {
        const pageFooters = document.querySelectorAll('footer')
        pageFooter = pageFooters[pageFooters.length - 1]
        updateParentTitle()
      })
    </script>
{% endblock %}
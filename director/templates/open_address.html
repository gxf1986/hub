{% extends 'base.html' %}

{% block styles %}
  {{ block.super }}
{% endblock %}

{% block scripts %}
{{ block.super }}
<script>
var convert = new Request("{% url 'convert' checkout.key %}", {
  method: "get", credentials: "same-origin",
});
fetch(convert).then(function() {
  document.getElementById("done").className += "done";
  window.location = "/edit?project={{ checkout.key }}";
});
function update_log() {
  console.log(this.responseText)
  var d = JSON.parse(this.responseText);
  var messages = [];
  d.messages.forEach(function(m) {messages.push(m.message)});
  var content = "<div>" + messages.join("</div><div>") + "</div>";
  document.getElementById("progress").innerHTML = content;
}
function fetch_log() {
  var progress = new XMLHttpRequest();
  progress.addEventListener("load", update_log);
  progress.open("GET", "{% url 'open-progress' checkout.key %}");
  progress.send();
  if (document.querySelector("#done.done")) {
    return;
  }
  setTimeout(fetch_log, 1000);
}
window.addEventListener("DOMContentLoaded", function(event) {
  fetch_log();
});
</script>
{% endblock %}

{% block content %}
<h3>{{ project.address }}</h3>
<div class="columns">
  <div class="column">
    <div id="status">Converting...</div>
    <div id="progress"></div>
    <div id="done"></div>
  </div>
</div>
{% endblock %}

{% block footer %}
{% endblock %}

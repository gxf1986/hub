{% extends 'open/main.html' %}
{% block header %}
    {% include "open/open_header.html" with brand_tag="/open" display_share=user_owns_conversion %}{% endblock %}
{% block main %}
    <iframe class="open-embed" id="article_display_{{ public_id }}" src="{{ raw_source }}"></iframe>
    {% include 'open/_output_footer.html' %}
{% endblock %}
{% block open_scripts %}
    <script>
      let conversionsFooter = document.querySelector('.conversions-footer')
      let pageFooter
      let pageFooterPosition = -1
      let conversionFooterOriginalBottom = -1

      {% if user_owns_conversion %}
        const feedbackModal = new Vue(
          {
            el: '#feedback_modal',
            delimiters: ['[[', ']]'],
            data: {
              rating: null,
              submitted: false,
              active: false,
              submitInProgress: false,
              comments: '',
              emailAddress: '',
              submitUrl: '{% url "open_feedback" public_id %}',
              submissionError: null,
              ratingErrors: null,
              emailErrors: null
            },
            methods: {
              showModal () {
                this.active = true
              },
              hideModal () {
                if (this.submitInProgress)
                  return

                this.active = false
              },
              setRating (rating) {
                this.ratingError = null
                this.rating = rating
              },
              send () {
                this.ratingErrors = null
                this.emailErrors = null

                if (this.rating === null) {
                  this.ratingErrors = ['Please select a rating.']
                  return
                }

                this.submissionError = null
                fetch(this.submitUrl, {
                  method: 'POST',
                  headers: {
                    'Accept': 'application/json',
                    'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8',
                    'X-CSRFToken': utils.cookie('csrftoken'),
                  },
                  credentials: 'same-origin',
                  body: new URLSearchParams({
                    rating: this.rating,
                    comments: this.comments,
                    email_address: this.emailAddress
                  })
                }).then(
                  response => {
                    this.submitInProgress = false
                    return response.json()
                  },
                  failureResponse => {
                    this.submitInProgress = false
                  }).then(data => {
                  if (data.success) {
                    this.submitted = true
                  } else {
                    if (data.errors) {
                      this.emailErrors = data.errors.email_address || null
                      this.ratingErrors = data.errors.rating || null
                    } else {
                      this.submissionError = 'An unknown error occurred during send.'
                    }

                    this.submissionError = null
                    this.submitted = false
                  }
                })
              }
            }
          })

        document.getElementById('feedback_button').onclick = function () {
          feedbackModal.showModal()
        }
      {% endif %}

      {% if log_messages %}
        document.getElementById('warnings_button').onclick = function () {
          document.getElementById('warnings_modal').classList.add('is-active')
        }

        document.getElementById('warnings_modal_close').onclick = function () {
          document.getElementById('warnings_modal').classList.remove('is-active')
        }
      {% endif %}
      {% if conversion_success %}
        const parentTitleEl = document.querySelector('title')

        const articleDisplay = document.getElementById('article_display_{{ public_id }}')

        function updateParentTitle () {
          let subTitle = articleDisplay.contentDocument.querySelector('title')
          if (subTitle)
            parentTitleEl.textContent = 'Open : Stencila : ' + subTitle.textContent
          articleDisplay.style.height = `${articleDisplay.contentWindow.document.body.scrollHeight}px`
          updatePageFooterPosition()
          scrollChange()
        }
        articleDisplay.onload = function () {
          updateParentTitle()
        }

      {% endif %}

      function updatePageFooterPosition () {
        if (!pageFooter || !conversionsFooter) return
        pageFooterPosition = pageFooter.getBoundingClientRect().top
        if (conversionFooterOriginalBottom === -1)
          conversionFooterOriginalBottom = parseInt(getComputedStyle(conversionsFooter).getPropertyValue('bottom'))
      }

      function scrollChange () {
        if (pageFooterPosition === -1) return

        const windowBottom = window.innerHeight + window.scrollY

        if (windowBottom > pageFooterPosition) {
          conversionsFooter.style.bottom = (windowBottom - pageFooterPosition) + conversionFooterOriginalBottom + 'px'
        } else {
          conversionsFooter.style.bottom = conversionFooterOriginalBottom + 'px'
        }
      }

      document.onscroll = scrollChange
      window.onresize = function () {
        updatePageFooterPosition()
        scrollChange()
      }

      window.onload = function () {
        const pageFooters = document.querySelectorAll('footer')
        pageFooter = pageFooters[pageFooters.length - 1]
        updateParentTitle()

        const downloadButton = document.getElementById('download_dropdown_button')
        if (downloadButton) {
          downloadButton.onclick = function () {
            document.getElementById('download_dropdown').classList.toggle('is-active')
          }
        }

        const shareButton = document.getElementById('share_dropdown_button')

        if (!shareButton)
          return

        document.getElementById('share_dropdown_button').onclick = function () {
          document.getElementById('share_dropdown').classList.toggle('is-active')
        }

        document.getElementById('share_copy_button').onclick = function () {
          const shareUrlEl = document.getElementById('id_share_url')

          shareUrlEl.focus()
          shareUrlEl.select()
          document.execCommand('copy')
        }
      }
    </script>
{% endblock %}
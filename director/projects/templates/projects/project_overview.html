{% extends 'projects/project_base.html' %}
{% load project_urls account_urls %}
{% block title %}{{ project.name }} : Overview{% endblock %}

{% block project_content %}
    <div>
        <p>This project is connected to the account:
            <strong>
                <a href="{% account_url 'account_profile' project.account %}">{{ project.account.name }}</a>
            </strong>
        </p>
        <br/>
    </div>
    <div class="columns">
        <div class="column is-three-quarters-desktop">
            {% if project.description %}
                <p>{{ project.description }}</p>
            {% else %}
                <p class="has-text-grey-light">No project description yet</p>
            {% endif %}
        </div>
    </div>
    <div class="columns">
        <div class="column is-12">
            <div id="terminal"
                  style="display: none; width:100%; height:100%; padding: 0.5em; background: black"></div>
        </div>
    </div>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/es6-promise/4.1.1/es6-promise.auto.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fetch/1.0.0/fetch.min.js"></script>
    <script src="https://unpkg.com/xterm@3.10.1/dist/xterm.js"></script>
    <script src="https://unpkg.com/xterm@3.10.1/dist/addons/fit/fit.js"></script>
    <script src="https://unpkg.com/xterm@3.10.1/dist/addons/attach/attach.js"></script>
    <script src="https://unpkg.com/xterm@3.10.1/dist/addons/winptyCompat/winptyCompat.js"></script>
    <link rel="stylesheet" href="https://unpkg.com/xterm@3.10.1/dist/xterm.css"/>
    <link rel="stylesheet" href="https://unpkg.com/xterm@3.10.1/dist/addons/fullscreen/fullscreen.css"/>
    <script>
      // Apply addons
      Terminal.applyAddon(attach)
      Terminal.applyAddon(fit)
      Terminal.applyAddon(winptyCompat)

      function setUpTerminal (location) {
        const term = new Terminal()
        term.winptyCompatInit()
        const container = document.getElementById('terminal')
        container.style.display = 'block'
        term.open(container)
        term.fit()
        const protocol = (window.location.protocol === 'https:') ? 'wss:' : 'ws:'
        const host = location.host ? location.host : window.location.host
        const url = `${protocol}//${host}${location.path}`
        const socket = new WebSocket(url)
        socket.onopen = (ev) => { term.attach(socket) }
        socket.onerror = (ev) => console.error(ev)
      }

      /*
      TODO: This el no longer exists
      new Vue(
        {
          el: '#id-project-actions',
          delimiters: ['[[', ']]'],
          data () {
            return {
              sessionStartUrl: '{% url "session_start_v1"  project.token cloud_environ %}',
              fileCheckoutUrl: '{% project_url 'project_pull' project %}',
              terminalSetup: false,
              checkoutInProgress: false
            }
          },
          methods: {
            startSession () {
              if (this.terminalSetup) {
                return
              }
              fetch(this.sessionStartUrl, {
                method: 'POST',
                headers: {
                  'Accept': 'application/json',
                  'X-CSRFToken': utils.cookie('csrftoken'),
                },
                credentials: 'same-origin'
              }).then(response => {
                  response.json().then(data => {
                    setUpTerminal(data.location)
                    this.terminalSetup = true
                  })
                },
                jsonFailure => {
                  console.error(jsonFailure)
                }
              ).catch(failureResponse => {
                alert(failureResponse.message)
              })
            }
          }
        })*/
    </script>
{% endblock %}

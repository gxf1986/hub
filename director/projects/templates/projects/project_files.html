{% extends 'projects/project_base.html' %}
{% load humanize static escape_extras source_extras project_permissions %}

{% block title %}Project {{ project.name }}: Files{% endblock %}
{% block project_header_right %}
    <div class="level-item buttons" id="file-action-bar">
        {% if project_permissions|project_permissions_contain:'edit' %}
            <input type="file" ref="file-upload" @change="handleFileUpload" class="is-hidden" multiple="multiple"/>
            <div class="dropdown" style="margin-right: 0.5em" id="new-item" :class="{ 'is-active':newMenuVisible }">
                <div class="dropdown-trigger">
                    <button @click.prevent="toggleNewMenu()" class="button is-primary" aria-haspopup="true"
                            aria-controls="dropdown-menu">
                    <span class="icon is-small">
                        <i class="fas fa-plus" aria-hidden="true"></i>
                    </span>
                        <span>New</span>
                        <span class="icon is-small">
                            <i class="fas fa-angle-down" aria-hidden="true"></i>
                        </span>
                    </button>
                </div>
                <div class="dropdown-menu" id="dropdown-menu" role="menu">
                    <div class="dropdown-content">
                        <a href="#" @click.prevent="createFile()" class="dropdown-item">
                        <span class="icon is-small">
                            <i class="fas fa-file" aria-hidden="true"></i>
                        </span>
                            <span>File&hellip;</span>
                        </a>
                        <a href="#" @click.prevent="createFolder()" class="dropdown-item">
                        <span class="icon is-small">
                            <i class="fas fa-folder" aria-hidden="true"></i>
                        </span>
                            <span>Folder&hellip;</span>
                        </a>
                        <a href="#" @click.prevent="showFileUploadSelect()" class="dropdown-item">
                        <span class="icon is-small">
                            <i class="fas fa-upload" aria-hidden="true"></i>
                        </span>
                            <span>File upload</span>
                        </a>
                    </div>
                </div>
            </div>

            <div class="dropdown" id="link" :class="{ 'is-active':linkMenuVisible }">
                <div class="dropdown-trigger" @click.prevent="toggleLinkMenu()">
                    <button class="button is-outlined" aria-haspopup="true"
                            aria-controls="dropdown-menu">
                    <span class="icon is-small">
                        <i class="fas fa-link" aria-hidden="true"></i>
                    </span>
                        <span>Link</span>
                        <span class="icon is-small">
                            <i class="fas fa-angle-down" aria-hidden="true"></i>
                        </span>
                    </button>
                </div>
                <div class="dropdown-menu" id="dropdown-menu" role="menu">
                    <div class="dropdown-content">
                        {% comment not supported yet %}
                    <a href="{% url 'dropboxsource_create' project.pk %}" class="dropdown-item">
                        <span class="icon is-small">
                            <i class="fab fa-dropbox" aria-hidden="true"></i>
                        </span>
                        <span>Dropbox</span>
                    </a>
                    {% endcomment %}
                        <a href="{% url 'githubsource_create' project.account.name project.name %}"
                           @click="showLinkModal($event, 'github', 'github')" class="dropdown-item">
                        <span class="icon is-small">
                            <i class="fab fa-github" aria-hidden="true"></i>
                        </span>
                            <span>Github&hellip;</span>
                        </a>
                        <a href="#" @click.prevent="showLinkModal($event, 'google', 'gdoc')" class="dropdown-item">
                        <span class="icon is-small">
                            <i class="fab fa-google" aria-hidden="true"></i>
                        </span>
                            <span>Google Docs&hellip;</span>
                        </a>
                        <a href="#" @click.prevent="showLinkModal($event, 'url', 'url')" class="dropdown-item">
                        <span class="icon is-small">
                            <i class="fas fa-globe" aria-hidden="true"></i>
                        </span>
                            <span>URL&hellip;</span>
                        </a>
                    </div>
                </div>
            </div>
            <a class="button is-outlined" style="margin-left: 0.5em" @click="pullFiles"
               id="project-pull-button">
                <span class="icon is-small"><i class="fas fa-file-export"></i></span>
                <span v-if="!pullInProgress">Pull Linked Sources</span>
                <span v-if="pullInProgress">Pulling Linked Sources&hellip;</span>
            </a>
                <a @click="snapshotProject" class="button is-outlined" :disabled="snapshotInProgress || snapshotComplete">
                    <span class="icon is-small">
                        <i class="fas fa-camera"></i>
                    </span>
                    <span v-if="!snapshotComplete && !snapshotInProgress">Snapshot Files</span>
                    <span v-if="!snapshotComplete && snapshotInProgress">Snapshot In Progress</span>
                    <span v-if="snapshotComplete">Snapshot Complete</span>
                </a>
        {% endif %}
    </div>
{% endblock %}
{% block project_content %}
    <script>
      const g_filePullUrl = "{% url 'project_pull' project.account.name project.name %}"
      const g_fileList = JSON.parse('{{ item_names|escapejs }}')
      const g_supportedSocialProviders = JSON.parse('{{ social_providers_supported|escapejs }}')
      const g_projectUpdateUrl = '{% url 'api_v1_project_detail' project.pk %}'
      const g_snapshotUrl = '{% url 'api_v1_project_snapshot' project.pk %}'
    </script>
    <div id="file-browser" ref="file-browser-root"
         data-item-create-url="{% url 'api_v1_project_item_create' project.id %}"
         data-item-rename-url="{% url 'api_v1_project_item_move' project.id %}"
         data-item-remove-url="{% url 'api_v1_project_item_remove' project.id %}">
        <add-item-modal
                directory-path="{{ current_directory }}"
        ></add-item-modal>

        <rename-item-modal
                directory-path="{{ current_directory }}"
        ></rename-item-modal>

        <remove-item-modal directory-path="{{ current_directory }}"></remove-item-modal>
        <convert-modal
                :existing-files="fileList"
                source-convert-url="{% url 'source_convert' project.account.name project.name %}"
        ></convert-modal>
        <upload-progress-modal
                upload-url="{% url 'filesource_upload' project.account.name project.name %}?directory={{ current_directory }}"></upload-progress-modal>
        <unsupported-social-provider-modal
                account-connections-url="{% url 'socialaccount_connections' %}"></unsupported-social-provider-modal>
        <googledocs-link-modal directory="{{ current_directory }}"
                               source-link-url="{% url 'api_v1_sources_link' project.pk %}"></googledocs-link-modal>
        <url-link-modal directory="{{ current_directory }}"
                        source-link-url="{% url 'api_v1_sources_link' project.pk %}"></url-link-modal>
        <publish-modal
                publish-url="{% url 'api_v1_project_item_publish' project.pk %}"
                project-url="http{% if request.is_secure %}s{% endif %}://
                        {{ request.get_host }}{% url 'project_overview' project.account.name project.name %}"
        ></publish-modal>
        {% if linked_sources %}
            <delete-confirm-modal :delete-modal-visible="unlinkModalVisible"
                                  delete-action="unlink_source"
                                  delete-id-name="source_id"
                                  :delete-id-value="unlinkSourceId"
                                  delete-button-label="Unlink"
                                  @modal-hide="hideUnlinkModal()">
                <template slot="title"><i class="fa fa-unlink"></i> Unlink <em>[[ unlinkSourceDescription ]]</em>?
                </template>
                <template slot="csrf_token">{% csrf_token %}</template>
                <template slot="body">
                    <p>Are you sure you want to unlink [[ SOURCE_TYPE_NAME_LOOKUP[unlinkSourceType] ]] source <em>[[
                        unlinkSourceDescription ]]</em> from this project?</p>
                    <p v-if="isUnlinkMulti" class="has-top-margin">
                        All files from this source will be removed from this project, but will still be available in
                        the [[ SOURCE_TYPE_NAME_LOOKUP[unlinkSourceType] ]] repository.</p>
                </template>
            </delete-confirm-modal>
        {% endif %}
        <nav class="breadcrumb" aria-label="breadcrumbs">
            <ul>
                {% for breadcrumb in breadcrumbs %}
                    <li {% if forloop.last %}class="is-active"{% endif %}>
                        <a href="

                                {% if breadcrumb.path %}{% url 'project_files_path' project.account.name project.name breadcrumb.path %}{% else %}{% url 'project_files' project.account.name project.name %}{% endif %}">
                            <span>
                                {{ breadcrumb.name }}
                            </span>
                        </a>
                    </li>
                {% endfor %}
            </ul>
        </nav>
        <table class="table is-fullwidth is-striped" id="files-table">
            <thead>
            <tr class="table-header">
                <th>Browse</th>
                <th>{# main file #}</th>
                <th class="has-text-centered">Source</th>
                <th>Updated</th>
                <th class="has-text-centered">Actions</th>
            </tr>
            </thead>
            <tbody id="file_list_body">
            {% for directory_entry in items %}
                <tr>
                    <td>
                        <p class="table-icon-label">
                            <i class="fa fa-{{ directory_entry|file_icon }}"></i>
                            {% if directory_entry.is_directory %}
                                <a href="{% source_path project directory_entry %}">
                            {% endif %}
                            {{ directory_entry.name }}
                            {% if directory_entry.is_directory %}
                                </a>
                            {% endif %}
                        </p>
                    </td>

                    <td class="has-text-right title-caption">
                        {% if directory_entry|is_main_file:project %}Main File{% endif %}
                    </td>

                    <td class="has-text-centered">
                        {% if directory_entry.source.type != 'filesource' or not directory_entry.is_directory %}
                            <span>{% include 'projects/_source_type_icon.html' with type=directory_entry.source.type source=directory_entry.source %}</span>
                        {% endif %}
                    </td>

                    <td>{{ directory_entry.modification_date|naturaltime }}</td>

                    <td class="has-text-centered">
                        <item-action-menu
                                :has-edit-permission="{% if project_permissions|project_permissions_contain:'edit' %}true{% else %}false{% endif %}"
                                :allow-rename="{% if project_permissions|project_permissions_contain:'edit' and directory_entry.allow_rename %}true{% else %}false{% endif %}"
                                :allow-delete="{% if project_permissions|project_permissions_contain:'edit' and directory_entry.allow_remove %}true{% else %}false{% endif %}"
                                :allow-desktop-launch="{% if directory_entry.name == 'manifest.xml' %}true{% else %}false{% endif %}"
                                :allow-edit="{% if directory_entry|is_text_editable %}true{% else %}false{% endif %}"
                                :allow-unlink="{% if project_permissions|project_permissions_contain:'edit' and directory_entry.source.type != 'disk' %}true{% else %}false{% endif %}"
                                {% if directory_entry|is_text_editable %}
                                editor-url="{% source_path project directory_entry %}"
                                edit-menu-text="{{ directory_entry|edit_menu_text }}"
                                {% endif %}
                                preview-url="{% url 'file_source_preview' project.account.name project.name directory_entry.path %}"
                                download-url="{% download_url project directory_entry %}"
                                source-type="{{ directory_entry.source.type }}"
                                source-identifier="{{ directory_entry.source.pk }}"
                                source-description="{{ directory_entry.source.description }}"
                                file-type="{% if directory_entry.is_directory %}directory{% else %}{{ directory_entry.mimetype }}{% endif %}"
                                absolute-path="{{ directory_entry.path|escape }}"
                                index="{{ forloop.counter0 }}"
                                file-name="{{ directory_entry.name }}"></item-action-menu>
                    </td>
                </tr>
            {% empty %}
                <tr>
                    <td colspan="6">There are no items in this directory.</td>
                </tr>
            {% endfor %}
            <tbody>
        </table>
    </div>
    <section class="section has-text-centered" id="session-wait-info">
        <div v-if="status == SESSION_SETUP_STATUS.CHECKING">
            <h5 class="subtitle is-5">Acquiring Session </h5>
            <i class="fas fa-spinner fa-spin"></i>
        </div>
        <div v-if="status == SESSION_SETUP_STATUS.REDIRECTING">
            <h5 class="subtitle is-5">Redirecting</h5>
            <i class="fas fa-spinner fa-spin"></i>
        </div>
        <div v-if="status == SESSION_SETUP_STATUS.QUEUED">
            <h5 class="subtitle is-5">Waiting to check for available Session</h5>
            <i class="fas fa-spinner fa-spin"></i>
            <p v-if="secondsToRecheck > 0">Next check in [[secondsToRecheck]] seconds.</p>
        </div>
        <div v-if="status == SESSION_SETUP_STATUS.CHECKING_QUEUE">
            <h5 class="subtitle is-5">Checking for available Session</h5>
            <i class="fas fa-spinner fa-spin"></i>
        </div>
        <div v-if="error" class="alert is-danger">
            <p>[[ error ]]</p>
        </div>
    </section>

    <script src="{% static "js/delete-confirm-modal.js" %}"></script>
    <script src="{% static "js/filebrowser.js" %}"></script>
    <script type="text/javascript">
      const TIME_BETWEEN_RECHECK_SECONDS = [5, 10, 30, 30, 60]
      let TIME_CHECK_INDEX = 0
      const SESSION_SETUP_STATUS = {
        IDLE: 0,
        CHECKING: 1,
        REDIRECTING: 2,
        QUEUED: 3,
        CHECKING_QUEUE: 4,
        ERROR: 5
      }

      function dataIsSessionRequestResponse (data) {
        return data.hasOwnProperty('invalid_session') || data.hasOwnProperty('start_session')
      }

      function dataIsErrorResponse (data) {
        return data.hasOwnProperty('error')
      }

      function buildDesktopPath (relativePath, sessionPath, token) {
        if (relativePath.substr(0, 1) == '/') {
          relativePath = relativePath.substr(1)
        }
        const filePath = '{{ project.id }}/' + relativePath
        return `/desktop/?path=${filePath}&session=/cloud${sessionPath}&token=${token}`
      }

      const sessionWaitController = new Vue({
        el: '#session-wait-info',
        delimiters: ['[[', ']]'],
        data: {
          SESSION_SETUP_STATUS: SESSION_SETUP_STATUS,
          relativePath: '',
          secondsToRecheck: TIME_BETWEEN_RECHECK_SECONDS[TIME_CHECK_INDEX],
          status: SESSION_SETUP_STATUS.IDLE,
          sessionCheckPath: '{{ session_check_path|escapejs }}',
          sessionStartPath: '{{ session_start_path|escapejs }}',
          checkResult: '',
          error: ''
        },
        methods: {
          startSession () {
            this.status = SESSION_SETUP_STATUS.CHECKING
            fetch(this.sessionStartPath + `?path=${this.relativePath}`, {
              method: 'POST',
              headers: {
                'Accept': 'application/json',
                'X-CSRFToken': utils.cookie('csrftoken'),
              },
              credentials: 'same-origin'
            }).then(response => {
              if (response.ok) {
                return response.json()
              }
              if (response.status === 504) {
                this.startSession()
                return null
              } else {
                throw 'Error when trying to start session. ' + response.bodyText
              }
            }).then(data => {
              if (data == null) {
                return // 504 handled above
              }
              if (dataIsErrorResponse(data)) {
                this.error = data.error
                return
              }

              if (dataIsSessionRequestResponse(data)) {
                this.handleSessionCheckResponse(data)
                return
              }

              if (data.status && (data.status === 'NOT_STARTED' || data.status === 'UNKNOWN')) {
                this.status = SESSION_SETUP_STATUS.QUEUED
                this.secondsToRecheck = TIME_BETWEEN_RECHECK_SECONDS[TIME_CHECK_INDEX++]
                TIME_CHECK_INDEX = Math.min(TIME_CHECK_INDEX, TIME_BETWEEN_RECHECK_SECONDS.length - 1)

                this.queueCheckTimerSetup()
                return
              }

              if (data.location) {
                this.status = SESSION_SETUP_STATUS.REDIRECTING
                window.location = buildDesktopPath(this.relativePath, data.location.path, data.location.token)
                this.status = SESSION_SETUP_STATUS.IDLE
                return
              }

              this.status = SESSION_SETUP_STATUS.ERROR
            }).catch(reason => {
              this.error = reason
              this.status = SESSION_SETUP_STATUS.ERROR
            })
          },
          handleSessionCheckResponse (response) {
            if (response.invalid_session) {
              this.status = SESSION_SETUP_STATUS.ERROR
              this.secondsToRecheck = -1
              this.error = 'Invalid session.'
            } else if (response.start_session) {
              this.status = SESSION_SETUP_STATUS.CHECKING
              this.secondsToRecheck = -1
              this.startSession()
            } else {
              this.status = SESSION_SETUP_STATUS.QUEUED
              this.secondsToRecheck = TIME_BETWEEN_RECHECK_SECONDS
              this.queueCheckTimerSetup()
            }
          },
          checkSession () {
            this.status = SESSION_SETUP_STATUS.CHECKING_QUEUE
            fetch(this.sessionCheckPath, {
              credentials: 'same-origin',

            }).then((response) => {
              return response.json()
            }, () => {
              this.status = SESSION_SETUP_STATUS.ERROR
              this.secondsToRecheck = -1
              this.error = 'Checking for session failed.'
            }).then((data) => {
              this.handleSessionCheckResponse(data)
            }, (failureReason) => {
              this.error = `Checking for session failed: ${failureReason}.`
            })
          },
          sessionCheckTimerSetup () {
            setTimeout(() => {
              --this.secondsToRecheck
              if (this.secondsToRecheck === 0) {
                this.checkSession()
              } else {
                this.sessionCheckTimerSetup()
              }
            }, 1000)
          },
          queueCheckTimerSetup () {
            setTimeout(() => {
              --this.secondsToRecheck
              if (this.secondsToRecheck === 0) {
                this.startSession()
              } else {
                this.queueCheckTimerSetup()
              }
            }, 1000)
          },
          launchDesktopEditor (path) {
            document.getElementById('session-wait-info').scrollIntoView()
            this.relativePath = path
            this.startSession()
          }
        },
      })
    </script>
{% endblock %}

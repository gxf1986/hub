{% extends 'base.html' %}
{% load humanize static escape_extras source_extras %}

{% block title %}Project {{ project.pk }}: Files{% endblock %}

{% block content %}
    {% include "projects/_project_header.html" with project=project tab="files" %}
    {% include "projects/_project_files_tabs.html" with project=project tab="files" %}

    <div class="level">
        <div class="level-right">
            <div class="level-item buttons">
                <a class="button is-primary"
                   href="{% url 'filesource_create' project.pk %}?directory={{ current_directory }}">
                    <span class="icon is-small">
                        <i class="fas fa-plus" aria-hidden="true"></i>
                    </span>
                    <span>New</span>
                </a>
                <a class="button is-primary"
                   href="{% url 'filesource_upload' project.pk %}?directory={{ current_directory }}">
                    <span class="icon is-small">
                        <i class="fas fa-upload" aria-hidden="true"></i>
                    </span>
                    <span>Upload</span>
                </a>
                <div class="dropdown" id="link" @click="active = !active" :class="{ 'is-active':active }">
                    <div class="dropdown-trigger">
                        <button class="button is-primary" aria-haspopup="true" aria-controls="dropdown-menu">
                            <span class="icon is-small">
                                <i class="fas fa-link" aria-hidden="true"></i>
                            </span>
                            <span>Link</span>
                            <span class="icon is-small">
                                    <i class="fas fa-angle-down" aria-hidden="true"></i>
                                </span>
                        </button>
                    </div>
                    <div class="dropdown-menu" id="dropdown-menu" role="menu">
                        <div class="dropdown-content">
                            {% comment not supported yet %}
                            <a href="{% url 'dropboxsource_create' project.pk %}" class="dropdown-item">
                                <span class="icon is-small">
                                    <i class="fab fa-dropbox" aria-hidden="true"></i>
                                </span>
                                <span>Dropbox</span>
                            </a>
                            {% endcomment %}
                            <a href="{% url 'githubsource_create' project.pk %}" class="dropdown-item">
                                <span class="icon is-small">
                                    <i class="fab fa-github" aria-hidden="true"></i>
                                </span>
                                <span>Github</span>
                            </a>
                        </div>
                    </div>
                </div>
                {% if linked_sources %}
                    <div class="dropdown" style="margin-left: 0.5em" id="unlink" @click="active = !active"
                         :class="{ 'is-active':active }">
                        <script src="{% static "js/delete-confirm-modal.js" %}"></script>
                        <delete-confirm-modal :delete-modal-visible="deleteModalVisible"
                                              delete-action="unlink_source"
                                              delete-id-name="source_id"
                                              :delete-id-value="unlinkSourceId"
                                              delete-button-label="Remove"
                                              @modal-hide="hideDeleteModal()">
                            <template slot="title">Unlink source?</template>
                            <template slot="csrf_token">{% csrf_token %}</template>
                            <template slot="body">Are you sure you want to unlink <em>[[ unlinkSourceDescription ]]</em>
                                from this project?
                            </template>
                        </delete-confirm-modal>
                        <div class="dropdown-trigger">
                            <button class="button is-primary" aria-haspopup="true" aria-controls="dropdown-menu">
                            <span class="icon is-small">
                                <i class="fas fa-unlink" aria-hidden="true"></i>
                            </span>
                                <span>Unlink</span>
                                <span class="icon is-small">
                                    <i class="fas fa-angle-down" aria-hidden="true"></i>
                                </span>
                            </button>
                        </div>
                        <div class="dropdown-menu" id="dropdown-menu" role="menu">
                            <div class="dropdown-content">
                                {% for linked_source in linked_sources %}
                                    <a href="#" class="dropdown-item"
                                       @click="showUnlinkModal('{{ linked_source|escape_single_quotes }}', {{ linked_source.pk }})">
                                        <span class="icon is-small">
                                            <i class="fab fa-github" aria-hidden="true"></i>
                                        </span>
                                        <span>
                                            {{ linked_source }}
                                        </span>
                                    </a>
                                {% endfor %}
                            </div>
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
    <table class="table is-fullwidth is-striped is-bordered">
        <thead>
        <tr>
            <th colspan="6">
                <nav class="breadcrumb" aria-label="breadcrumbs">
                    <ul>
                        {% for breadcrumb in breadcrumbs %}
                            <li {% if forloop.last %}class="is-active"{% endif %}>
                                <a href="
                                        {% if breadcrumb.path %}{% url 'project_files_path' project.pk breadcrumb.path %}{% else %}{% url 'project_files' project.pk %}{% endif %}">
                                    {% if forloop.first %}
                                        <span class="icon is-small"><i class="fas fa-home"
                                                                       aria-hidden="true"></i></span>
                                    {% endif %}
                                    <span>
                                        {{ breadcrumb.name }}
                                    </span>
                                </a>
                            </li>
                        {% endfor %}
                    </ul>
                </nav>
            </th>
        </tr>
        <tr>
            <th>Type</th>
            <th>Browse</th>
            <th>Source</th>
            <th>Open</th>
            <th>Updated</th>
            <th></th>
        </tr>
        </thead>
        <tbody id="file_list_body">
        {% for directory_entry in items %}
            <tr>
                <td>
                    {% if directory_entry.is_directory %}
                        Directory
                    {% else %}
                        {{ directory_entry.mimetype }}
                    {% endif %}
                </td>
                <td>
                    {% if directory_entry.is_directory %}
                        <a href="{% source_path project directory_entry %}">
                    {% endif %}
                    {{ directory_entry.name }}
                    {% if directory_entry.is_directory %}
                        </a>
                    {% endif %}
                </td>

                <td>
                    {% if directory_entry.source.type != 'filesource' or not directory_entry.is_directory %}
                        {% include 'projects/_source_type_icon.html' with type=directory_entry.source.type %}
                    {% endif %}
                </td>

                <td>
                    {% if directory_entry|is_text_editable %}
                        <form method="post" action="{% url 'project_session_setup' project.token environ %}?path={{ directory_entry.path }}">
                            {% csrf_token %}
                            {% if project.key %}
                                <input type="hidden" name="key" value="{{ project.key }}">
                            {% endif %}
                            <div class="select">
                                <select @change="editorSelectChange">
                                    <option>Open with&hellip;</option>
                                    <option value="code-editor"
                                            data-editor-url="{% source_path project directory_entry %}">Code editor
                                    </option>
                                    {% if directory_entry.name == 'manifest.xml' %}
                                        <option value="desktop">Stencila Desktop</option>
                                    {% endif %}
                                </select>
                            </div>
                        </form>
                    {% endif %}
                </td>

                <td>{{ directory_entry.modification_date|naturaltime }}</td>

                <td>
                    {% if directory_entry.source.type == 'filesource' and not directory_entry.is_directory %}
                        <a class="icon"
                           href="{% url 'source_update' project.pk directory_entry.source.id %}?from={{ current_directory }}">
                            <i class="fas fa-cog"></i>
                        </a>
                        <a class="icon has-text-danger"
                           href="{% url 'source_delete' project.pk directory_entry.source.id %}?from={{ current_directory }}">
                            <i class="fas fa-trash"></i>
                        </a>
                    {% endif %}
                </td>
            </tr>
        {% empty %}
            <tr>
                <td colspan="6">There are no items in this directory.</td>
            </tr>
        {% endfor %}
        <tbody>
    </table>
    <script type="text/javascript">
      new Vue({
        el: '#file_list_body',
        methods: {
          editorSelectChange (e) {
            const select = e.target
            const selectedIndex = select.selectedIndex

            const selectedOption = select.options[selectedIndex]

            const selectValue = selectedOption.getAttribute('value')

            if (!selectValue) {
              return
            }

            const editorUrl = selectedOption.getAttribute('data-editor-url')

            if (editorUrl) {
              window.location = editorUrl
              return
            }

            select.form.submit()
          }
        }
      })

      new Vue({
        el: '#link',
        data: {active: false}
      })

      {% if linked_sources %}
        new Vue({
          el: '#unlink',
          delimiters: ['[[', ']]'],
          data: {
            active: false,
            deleteModalVisible: false,
            unlinkSourceId: null,
            unlinkSourceDescription: ''
          }, methods: {
            hideDeleteModal () {
              this.deleteModalVisible = false
            },
            showUnlinkModal (sourceDescription, sourceId) {
              this.unlinkSourceDescription = sourceDescription
              this.unlinkSourceId = sourceId
              this.deleteModalVisible = true
            }
          }
        })
      {% endif %}
    </script>
{% endblock %}
